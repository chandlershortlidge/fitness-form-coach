<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Tester - Fitness Form Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .source-card { transition: all 0.2s ease; }
        .source-card:hover { transform: translateY(-2px); }
        .score-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="app"></div>

    <script type="module">
        import { createElement as h, useState, useEffect } from 'https://esm.sh/react@18';
        import { createRoot } from 'https://esm.sh/react-dom@18/client';

        const API_URL = 'http://localhost:8000';

        function App() {
            const [input, setInput] = useState('');
            const [exerciseFilter, setExerciseFilter] = useState('');
            const [messages, setMessages] = useState([]);
            const [loading, setLoading] = useState(false);
            const [apiStatus, setApiStatus] = useState('checking');

            // Check API health on mount
            useEffect(() => {
                fetch(`${API_URL}/health`)
                    .then(r => r.json())
                    .then(data => setApiStatus(`connected (${data.vectorstore_docs} docs)`))
                    .catch(() => setApiStatus('disconnected'));
            }, []);

            const stats = {
                total: messages.length,
                pass: messages.filter(m => m.status === 'pass').length,
                fail: messages.filter(m => m.status === 'fail').length,
                unreviewed: messages.filter(m => !m.status).length,
            };

            const handleSubmit = async () => {
                if (!input.trim() || loading) return;

                const question = input;
                setInput('');
                setLoading(true);

                // Add placeholder message
                const tempId = Date.now();
                setMessages(prev => [...prev, {
                    id: tempId,
                    question,
                    answer: 'Processing...',
                    sources: [],
                    time: '—',
                    status: null,
                    note: '',
                    expanded: true
                }]);

                try {
                    const response = await fetch(`${API_URL}/query`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            question,
                            k: 3,
                            exercise_filter: exerciseFilter || null
                        })
                    });
                    const data = await response.json();

                    setMessages(prev => prev.map(m =>
                        m.id === tempId ? {
                            ...m,
                            answer: data.answer,
                            sources: data.sources,
                            time: `${(data.total_time_ms / 1000).toFixed(1)}s`,
                            retrievalTime: `${data.retrieval_time_ms.toFixed(0)}ms`,
                            generationTime: `${(data.generation_time_ms / 1000).toFixed(1)}s`
                        } : m
                    ));
                } catch (err) {
                    setMessages(prev => prev.map(m =>
                        m.id === tempId ? {
                            ...m,
                            answer: `Error: ${err.message}. Is the API running?`,
                            status: 'fail'
                        } : m
                    ));
                }
                setLoading(false);
            };

            const toggleStatus = (id, newStatus) => {
                setMessages(prev => prev.map(m =>
                    m.id === id ? { ...m, status: m.status === newStatus ? null : newStatus } : m
                ));
            };

            const updateNote = (id, note) => {
                setMessages(prev => prev.map(m => m.id === id ? { ...m, note } : m));
            };

            const toggleExpand = (id) => {
                setMessages(prev => prev.map(m => m.id === id ? { ...m, expanded: !m.expanded } : m));
            };

            const exportResults = () => {
                const data = messages.map(m => ({
                    question: m.question,
                    answer: m.answer,
                    status: m.status || 'unreviewed',
                    note: m.note,
                    sources: m.sources?.map(s => ({ title: s.title, exercise: s.exercise_type, score: s.score }))
                }));
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rag-test-results-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };

            return h('div', { className: 'min-h-screen flex flex-col' },
                // Header
                h('div', { className: 'border-b border-gray-700 px-6 py-4' },
                    h('div', { className: 'max-w-4xl mx-auto flex items-center justify-between' },
                        h('div', null,
                            h('h1', { className: 'text-lg font-semibold' }, 'RAG Tester'),
                            h('p', { className: 'text-sm text-gray-500' }, 'Fitness Form Coach • Debug retrieval issues')
                        ),
                        h('div', { className: 'flex items-center gap-4 text-sm' },
                            h('span', {
                                className: `px-2 py-1 rounded text-xs ${apiStatus.includes('connected') ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`
                            }, apiStatus),
                            h('span', { className: 'text-gray-500' }, `${stats.total} tests`),
                            h('span', { className: 'text-green-500' }, `✓ ${stats.pass}`),
                            h('span', { className: 'text-red-500' }, `✗ ${stats.fail}`),
                            stats.total > 0 && h('button', {
                                onClick: exportResults,
                                className: 'px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs'
                            }, 'Export')
                        )
                    )
                ),

                // Messages
                h('div', { className: 'flex-1 overflow-y-auto pb-32' },
                    h('div', { className: 'max-w-4xl mx-auto py-6 px-6 space-y-4' },
                        messages.map(msg =>
                            h('div', {
                                key: msg.id,
                                className: `rounded-lg border ${
                                    msg.status === 'fail' ? 'border-red-500/50 bg-red-950/20' :
                                    msg.status === 'pass' ? 'border-green-500/30 bg-gray-800/50' :
                                    'border-gray-700 bg-gray-800/50'
                                }`
                            },
                                // Question
                                h('div', { className: 'px-4 py-3 border-b border-gray-700/50' },
                                    h('div', { className: 'flex items-start justify-between gap-4' },
                                        h('div', { className: 'flex-1' },
                                            h('span', { className: 'text-xs text-gray-500 uppercase tracking-wider' }, 'Question'),
                                            h('p', { className: 'text-gray-100 mt-1' }, msg.question)
                                        ),
                                        h('div', { className: 'text-right text-xs text-gray-600' },
                                            h('div', null, msg.time),
                                            msg.retrievalTime && h('div', null, `retrieval: ${msg.retrievalTime}`)
                                        )
                                    )
                                ),

                                // Answer
                                h('div', { className: 'px-4 py-3' },
                                    h('span', { className: 'text-xs text-gray-500 uppercase tracking-wider' }, 'Response'),
                                    h('p', { className: 'text-gray-300 mt-1 whitespace-pre-wrap' }, msg.answer)
                                ),

                                // Sources (collapsible)
                                msg.sources?.length > 0 && h('div', { className: 'px-4 py-3 border-t border-gray-700/50' },
                                    h('button', {
                                        onClick: () => toggleExpand(msg.id),
                                        className: 'flex items-center gap-2 text-xs text-gray-500 uppercase tracking-wider hover:text-gray-400'
                                    },
                                        h('span', null, msg.expanded ? '▼' : '▶'),
                                        h('span', null, `Retrieved Sources (${msg.sources.length})`)
                                    ),
                                    msg.expanded && h('div', { className: 'mt-3 space-y-2' },
                                        msg.sources.map((src, i) =>
                                            h('div', {
                                                key: i,
                                                className: 'source-card p-3 bg-gray-900/50 rounded border border-gray-700'
                                            },
                                                h('div', { className: 'flex items-start justify-between gap-2 mb-2' },
                                                    h('div', { className: 'flex items-center gap-2 flex-wrap' },
                                                        h('span', { className: 'text-xs px-2 py-0.5 bg-blue-900/50 text-blue-300 rounded' }, src.exercise_type),
                                                        h('span', { className: 'text-xs text-gray-500' }, src.title)
                                                    ),
                                                    h('div', { className: 'flex items-center gap-2' },
                                                        h('div', { className: 'w-16 h-1.5 bg-gray-700 rounded overflow-hidden' },
                                                            h('div', {
                                                                className: 'score-bar h-full bg-green-500',
                                                                style: { width: `${Math.max(0, 100 - (src.score * 100))}%` }
                                                            })
                                                        ),
                                                        h('span', { className: 'text-xs text-gray-500 w-12 text-right' }, src.score?.toFixed(3))
                                                    )
                                                ),
                                                h('p', { className: 'text-sm text-gray-400 leading-relaxed' }, src.content)
                                            )
                                        )
                                    )
                                ),

                                // Actions
                                h('div', { className: 'px-4 py-2 border-t border-gray-700/50 flex items-center gap-2' },
                                    h('button', {
                                        onClick: () => toggleStatus(msg.id, 'pass'),
                                        className: `px-3 py-1 rounded text-xs font-medium transition-colors ${
                                            msg.status === 'pass'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-700 text-gray-400 hover:bg-gray-600'
                                        }`
                                    }, '✓ Pass'),
                                    h('button', {
                                        onClick: () => toggleStatus(msg.id, 'fail'),
                                        className: `px-3 py-1 rounded text-xs font-medium transition-colors ${
                                            msg.status === 'fail'
                                                ? 'bg-red-600 text-white'
                                                : 'bg-gray-700 text-gray-400 hover:bg-gray-600'
                                        }`
                                    }, '✗ Fail'),
                                    h('input', {
                                        type: 'text',
                                        placeholder: 'Add note (e.g., "wrong source retrieved")...',
                                        value: msg.note || '',
                                        onChange: (e) => updateNote(msg.id, e.target.value),
                                        className: 'flex-1 ml-2 px-3 py-1 bg-gray-700/50 border border-gray-600 rounded text-xs text-gray-300 placeholder-gray-500 focus:outline-none focus:border-gray-500'
                                    })
                                )
                            )
                        ),

                        messages.length === 0 && h('div', { className: 'text-center py-20 text-gray-500' },
                            h('p', { className: 'text-lg' }, 'No tests yet'),
                            h('p', { className: 'text-sm mt-1' }, 'Ask a question below to test your RAG system')
                        )
                    )
                ),

                // Input - Fixed at bottom
                h('div', { className: 'fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 px-6 py-4' },
                    h('div', { className: 'max-w-4xl mx-auto' },
                        h('div', { className: 'flex gap-3 mb-2' },
                            h('select', {
                                value: exerciseFilter,
                                onChange: (e) => setExerciseFilter(e.target.value),
                                className: 'px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 text-sm focus:outline-none focus:border-gray-600'
                            },
                                h('option', { value: '' }, 'All exercises'),
                                h('option', { value: 'bench_press' }, 'Bench Press'),
                                h('option', { value: 'squat' }, 'Squat'),
                                h('option', { value: 'overhead_press' }, 'Overhead Press')
                            ),
                            h('input', {
                                type: 'text',
                                value: input,
                                onChange: (e) => setInput(e.target.value),
                                onKeyPress: (e) => e.key === 'Enter' && handleSubmit(),
                                placeholder: 'Type a test question...',
                                disabled: loading,
                                className: 'flex-1 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-100 placeholder-gray-500 focus:outline-none focus:border-gray-600 disabled:opacity-50'
                            }),
                            h('button', {
                                onClick: handleSubmit,
                                disabled: loading || !input.trim(),
                                className: 'px-6 py-2 bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:hover:bg-gray-700 rounded-lg text-gray-200 font-medium transition-colors'
                            }, loading ? 'Sending...' : 'Send')
                        )
                    )
                )
            );
        }

        createRoot(document.getElementById('app')).render(h(App));
    </script>
</body>
</html>
